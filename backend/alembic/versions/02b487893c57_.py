"""

Revision ID: 02b487893c57
Revises: 7bf2c8fe7033
Create Date: 2025-11-18 17:21:55.061004

"""

from typing import Sequence, Union

import sqlalchemy as sa
from alembic_utils.pg_policy import PGPolicy
from sqlalchemy import text as sql_text

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "02b487893c57"
down_revision: Union[str, Sequence[str], None] = "7bf2c8fe7033"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.disable_rls("public", "users")
    public_users_team_member_access_policy = PGPolicy(
        schema="public",
        signature="team_member_access_policy",
        on_entity="public.users",
        definition="as PERMISSIVE for ALL to public using (((NULLIF(current_setting('app.is_system_mode'::text, true), ''::text))::boolean IS TRUE) OR (NULLIF(current_setting('app.team_id'::text, true), ''::text) IS NULL) OR ((NULLIF(current_setting('app.team_id'::text, true), ''::text) IS NOT NULL) AND (id IN ( SELECT roles.user_id\n   FROM roles\n  WHERE (roles.team_id = (NULLIF(current_setting('app.team_id'::text, true), ''::text))::integer)))))",
    )
    op.drop_entity(public_users_team_member_access_policy)

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    public_users_team_member_access_policy = PGPolicy(
        schema="public",
        signature="team_member_access_policy",
        on_entity="public.users",
        definition="as PERMISSIVE for ALL to public using (((NULLIF(current_setting('app.is_system_mode'::text, true), ''::text))::boolean IS TRUE) OR (NULLIF(current_setting('app.team_id'::text, true), ''::text) IS NULL) OR ((NULLIF(current_setting('app.team_id'::text, true), ''::text) IS NOT NULL) AND (id IN ( SELECT roles.user_id\n   FROM roles\n  WHERE (roles.team_id = (NULLIF(current_setting('app.team_id'::text, true), ''::text))::integer)))))",
    )
    op.create_entity(public_users_team_member_access_policy)

    op.enable_rls("public", "users")
    # ### end Alembic commands ###
