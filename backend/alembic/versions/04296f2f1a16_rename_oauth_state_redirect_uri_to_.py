"""Rename OAuth state redirect_uri to return_url and make NOT NULL

Revision ID: 04296f2f1a16
Revises: 82e1cad9f41e
Create Date: 2025-12-21 21:46:18.669408

"""

from collections.abc import Sequence

import sqlalchemy as sa
from alembic_utils.pg_policy import PGPolicy

from alembic import op

# revision identifiers, used by Alembic.
revision: str = "04296f2f1a16"
down_revision: str | Sequence[str] | None = "82e1cad9f41e"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###

    # Step 1: Delete expired OAuth states (they're ephemeral, 10-minute lifespan)
    op.execute("DELETE FROM google_oauth_states WHERE expires_at < NOW()")

    # Step 2: Add return_url column as nullable first
    op.add_column("google_oauth_states", sa.Column("return_url", sa.Text(), nullable=True))

    # Step 3: Copy existing redirect_uri data to return_url, use configured default for NULLs
    op.execute("""
        UPDATE google_oauth_states
        SET return_url = COALESCE(redirect_uri, 'http://localhost:3000/')
    """)

    # Step 4: Make return_url NOT NULL now that all rows have values
    op.alter_column("google_oauth_states", "return_url", nullable=False)

    # Step 5: Drop old redirect_uri column
    op.drop_column("google_oauth_states", "redirect_uri")
    op.enable_rls("public", "widgets")
    public_widgets_team_scope_policy = PGPolicy(
        schema="public",
        signature="team_scope_policy",
        on_entity="public.widgets",
        definition="AS PERMISSIVE\n                        FOR ALL\n                        USING (\n                            NULLIF(current_setting('app.is_system_mode', true), '')::boolean IS TRUE\n                            OR (NULLIF(current_setting('app.team_id', true), '') IS NOT NULL\n                                AND team_id = NULLIF(current_setting('app.team_id', true), '')::int)\n                        )",
    )
    op.create_entity(public_widgets_team_scope_policy)

    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    public_widgets_team_scope_policy = PGPolicy(
        schema="public",
        signature="team_scope_policy",
        on_entity="public.widgets",
        definition="AS PERMISSIVE\n                        FOR ALL\n                        USING (\n                            NULLIF(current_setting('app.is_system_mode', true), '')::boolean IS TRUE\n                            OR (NULLIF(current_setting('app.team_id', true), '') IS NOT NULL\n                                AND team_id = NULLIF(current_setting('app.team_id', true), '')::int)\n                        )",
    )
    op.drop_entity(public_widgets_team_scope_policy)

    op.disable_rls("public", "widgets")
    op.add_column("google_oauth_states", sa.Column("redirect_uri", sa.TEXT(), autoincrement=False, nullable=True))
    op.drop_column("google_oauth_states", "return_url")
    # ### end Alembic commands ###
